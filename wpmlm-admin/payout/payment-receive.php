<?phpini_set('max_execution_time', 330); //300 seconds = 5.5 minutesinclude('../../../../../wp-config.php');include_once(WPMLM_FILE_PATH . '/wpmlm-admin/order.class.php'); global $wpdb; global $table_prefix;	/*$action = '';$action = $_REQUEST['action'];if($action=='load'){*/    $settings=get_option('wpmlm_general_settings');     $mapping = get_option('wpmlm_mapping_settings');    if($settings['ecom_option']=='wp-ecommerce')    {        $payemnt_status=$mapping['wpmlm_wp_ecom_payment'];        $orders=$wpdb->get_results( "SELECT id, totalprice,user_ID  FROM {$table_prefix}wpsc_purchase_logs WHERE processed='".$payemnt_status."' AND id NOT IN(SELECT order_id FROM {$table_prefix}wpmlm_pv_detail)");	    }    else if($settings['ecom_option']=='jigoshop')    {        $payemnt_status=$mapping['wpmlm_wp_jigoshop_payment'];            $orders=$wpdb->get_results( "SELECT p.id as id, pm.meta_value as totalprice,pm1.meta_value as user_ID  FROM {$table_prefix}posts as p INNER JOIN {$table_prefix}postmeta as pm INNER JOIN {$table_prefix}postmeta as pm1 INNER JOIN {$table_prefix}term_relationships as tr ON p.id=pm.post_id AND p.id=pm1.post_id AND p.id=tr.object_id WHERE pm.meta_key='order_data' AND pm1.meta_key='customer_user' AND p.post_type='shop_order' AND post_status='publish' AND tr.term_taxonomy_id='".$payemnt_status."' AND p.id NOT IN(SELECT order_id FROM {$table_prefix}wpmlm_pv_detail)");     }    else if($settings['ecom_option']=='woocommerce')    {       $payemnt_status=$mapping['wpmlm_wp_woocommerce_payment'];            $orders=$wpdb->get_results( "SELECT p.id as id, pm.meta_value as totalprice,pm1.meta_value as user_ID  FROM {$table_prefix}posts as p INNER JOIN {$table_prefix}postmeta as pm INNER JOIN {$table_prefix}postmeta as pm1 INNER JOIN {$table_prefix}term_relationships as tr ON p.id=pm.post_id AND p.id=pm1.post_id AND p.id=tr.object_id WHERE pm.meta_key='_order_total' AND pm1.meta_key='_customer_user' AND p.post_type='shop_order' AND post_status='publish' AND tr.term_taxonomy_id='".$payemnt_status."' AND p.id NOT IN(SELECT order_id FROM {$table_prefix}wpmlm_pv_detail)");                 }        $i = 1;	 	if($wpdb->num_rows>0)	{?>		<div style="font-size:11px;">		<table width="100%" bordercolor="#dddddd" border="1" style="border: 1px solid #dddddd; font-size:11px; 		border-collapse: collapse; padding: 8px; margin:13px auto 10px auto;" cellspacing="5" cellpadding="5" align="center">		 <tr style="background:#F0F0F0; border:solid 1px #DDDDDD; color:#333333;">			<th scope="col" width="5%">S.No.</th>			<th scope="col" width="20%">Order Id</th>			<th scope="col"width="8%">user Id</th>			<th scope="col" width="8%">Total Amount</th>			<th scope="col" width="10%">Total Pv</th>					  </tr>		<?php foreach( $orders as $row) :  ?>		  <tr>                        <?php 			if($settings['ecom_option']=='wp-ecommerce')                        {                            $total_price=$row->totalprice;                            $total_pv=totalPvForOrder($row->id);                                                    }                        else if($settings['ecom_option']=='jigoshop')                        {                            $order_item=get_post_meta($row->id,'order_items',true);                            $listArr=totalPvForJigoshop($order_item);                            $total_price=$listArr['total_price'];                            $total_pv=$listArr['total_pv'];                         }                         else if($settings['ecom_option']=='woocommerce')                        {                            $total_price=$row->totalprice;                                                        $total_pv=totalPvForWoocommerce($row->id);                         }                                                  ?>			<td><?= $i; ?></td>			<td><?= $row->id; ?></td>			<td><?= $row->user_ID; ?></td>			<td><?= $total_price; ?></td>			<td align="right"><?= $total_pv;?></td>			<?php 				$sql = "INSERT INTO {$table_prefix}wpmlm_pv_detail (order_id,user_id,total_amount,total_pv) values ( $row->id, $row->user_ID,$total_price,$total_pv)";				mysql_query($sql);			?>					  </tr>	   <?php $i++; endforeach; ?>		</table>	   <div>	   <?php	}else{		$msg = "<h3>No record Found</h3>";		echo $msg; 	   }//}function totalPvForOrder($order_id){global $wpdb; global $table_prefix;     	$pids = $wpdb->get_results( "SELECT prodid,quantity	FROM {$table_prefix}wpsc_cart_contents WHERE purchaseid=$order_id");       	if($wpdb->num_rows>0)	{		$pv_total='';		foreach($pids as $pid)		{			$pv_value = get_post_meta( $pid->prodid, 'pv_value', TRUE );			$qty=$pid->quantity;			$pv=$pv_value*$qty;			$pv_total+=$pv;		}		return $pv_total;	}else		return 0;}function totalPvForJigoshop($order_item){  $total_price='';    $total_pv='';    $i=1;    foreach($order_item as $row)    {           $pv_value=get_post_meta($row['id'],'pv_value',true);                $total_price+=$row['qty']*$row['cost'];        $total_pv+=$row['qty']*$pv_value;           }    return array('total_price'=>$total_price,'total_pv'=>$total_pv);}function totalPvForWoocommerce($order_id){         global $wpdb;    $data=$wpdb->get_results("SELECT  woi.meta_value as qty,woip.meta_value as pid FROM wp_woocommerce_order_itemmeta as woi INNER JOIN wp_woocommerce_order_items as woitem INNER JOIN wp_woocommerce_order_itemmeta as woip ON woi.order_item_id=woitem.order_item_id AND woip.order_item_id = woitem.order_item_id WHERE woi.meta_key='_qty'  AND  woip.meta_key='_product_id' AND woitem.order_id='$order_id'");    $total_pv='';    foreach($data as $row)    {           $pv_value=get_post_meta($row->pid,'pv_value',true);                $total_pv+=$row->qty*$pv_value;           }    return $total_pv;}?>